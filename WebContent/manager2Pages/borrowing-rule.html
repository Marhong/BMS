<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Responsive Bootstrap Advance Admin Template</title>
	<link rel="stylesheet" type="text/css" href="../css/default.css" />
	<link rel="stylesheet" type="text/css" href="../css/component.css" />
	<script src="../js/modernizr.custom.js"></script>


<!-- BOOTSTRAP STYLES-->

<!-- FONTAWESOME STYLES-->
<link href="../assets/css/font-awesome.css" rel="stylesheet" />
<!--CUSTOM BASIC STYLES-->
<link href="../assets/css/basic.css" rel="stylesheet" />
<!--CUSTOM MAIN STYLES-->
<link href="../assets/css/custom.css" rel="stylesheet" />
<link href="../css/base.css" type="text/css" rel="stylesheet" />

<link href="../assets/css/bootstrap.css" rel="stylesheet" />
<!-- GOOGLE FONTS-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans'
	rel='stylesheet' type='text/css' />
<style>
.table th, td {
	text-align: center;
}
	#more{
		color: #fff;
background-color: #428bca;
border-color: #357ebd;
}

#more:hover {
   
        background-color: #285e8e;
}
.test{
display: inline-block;
padding: 6px 12px;
margin-bottom: 0;
font-size: 14px;
font-weight: normal;
line-height: 1.42857143;
text-align: center;
white-space: nowrap;
vertical-align: middle;
cursor: pointer;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
background-image: none;
border: 1px solid transparent;
    border-top-color: transparent;
    border-right-color: transparent;
    border-bottom-color: transparent;
    border-left-color: transparent;
border-radius: 4px;}
</style>
</head>
<body onload="judgeState()">
			<div class="md-modal md-effect-16" id="modal-16">
			<div class="md-content">
				<h3>Announcement Detail</h3>
				<div>
					<ul>
						<li><strong>ID:</strong> <span id="announcementId">modal windows will probably tell you something important so don't forget to read what they say.</span></li>
						<li><strong>Time:</strong><span id="announcementTime">a modal window enjoys a certain kind of attention; just look at it and appreciate its presence.</span></li>
						<li><strong>Content:</strong> <span id="announcementContent">click on the button below to close the modal.click on the button below to close the modal.</span></li>
					</ul>
					<button id ="more2" class="md-close">Close me!</button>
				</div>
			</div>
		</div>
	<div id="wrapper" >
		<nav class="navbar navbar-default navbar-cls-top " role="navigation"
			style="margin-bottom: 0;background:#00CA79;">
			<div class="navbar-header" >
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".sidebar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html">Librarian</a>
			</div>

			<div class="header-right" >
 <a href="#"
					class="btn btn-danger" title="Logout" onclick="logout()"><i
					class="fa fa-exclamation-circle fa-2x"></i></a>


			</div>
		</nav>
		<!-- /. NAV TOP  -->
		<nav class="navbar-default navbar-side" role="navigation">
			<div class="sidebar-collapse">
				<ul class="nav" id="main-menu">
					<li>
						<div class="user-img-div">
							<img src="../assets/img/user.png" class="img-thumbnail" />

							<div class="inner-text">
							<span id="userName"></span>
							</div>
						</div>

					</li>


					
					<li><a href="#" class="active-menu-top"><i
							class="glyphicon glyphicon-user "></i>Reader Management <span
							class="fa arrow"></span></a>
						<ul class="nav nav-second-level collapse in">
							<li><a  href="reader-information.html">Reader
									Information Management</a></li>
<!-- 							<li><a href="reader-category.html">Reader Category -->
<!-- 									Management</a></li> -->
							<li><a class="active-menu" href="borrowing-rule.html">Reader
							Announcement Management</a></li>


						</ul></li>
					<li><a href="#"><i class="glyphicon glyphicon-book "></i>Book
							Management <span class="fa arrow"></span></a>
						<ul class="nav nav-second-level">
							<li><a href="book-information.html">Book Information
									Management</a></li>
<!-- 							<li><a href="book-category.html">Book Category -->
<!-- 									Management</a></li> -->


						</ul></li>
					 <li><a href="return-book.html" ><i class="fa fa-bicycle "></i>Book
							Borrowing Management </a>
						</li>

					 <li><a href="query-overdue-record.html" ><i class="glyphicon glyphicon-stats  "></i>Book
							Borrowing Statistics </a>
						</li>

				</ul>

			</div>

		</nav>
		<!-- /. NAV SIDE  -->

		<div id="page-wrapper">
			<div id="page-inner">
				<div class="row">
					<div class="col-md-12">
						<h1 class="page-head-line">Announcement Management</h1>
						<h1 class="page-subhead-line">
							<button id="queryAnnouncement" class="btn btn-default btn-lg"
								type="button" style="margin-right: 18px;" onclick="queryAnnouncement()">Query
								Announcement</button>
							<button id="deliverAnnouncement" class="btn btn-default btn-lg" type="button"
								style="margin-right: 18px;" onclick="deliverAnnouncement()">Deliver
								Announcement</button>

						</h1>
						
					</div>
				</div>
				<div class="row" id="addUserDiv" style="display: none;">
<div class="col-md-6 col-md-offset-3" >
			<p><textarea id="content" class="form-control" style="width:400px;height:300px;"></textarea></p>
				<p><button onclick="resetContent()" type="button" class="btn btn-default" style="margin-right:50px;margin-left:200px;">Reset</button><button onclick="delivertContent()" type="button" class="btn btn-primary" >Deliver</button></p>
				</div>
				</div>
				<div class="row" id="queryUserDiv" style="display: block;">

					<div class="form-group input-group col-md-6 col-md-offset-2" >

							<span  class="input-group-addon" style="background:none;border:none;"><div class="btn-group" style="width:90px;">
  <button id="type" onclick="changeType3()" style="width:170px;"  type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
  &nbsp&nbsp&nbsp Announcement&nbsp&nbsp Content &nbsp&nbsp&nbsp
  </button>

  </div>
</span>

							
							<span class="input-group-btn"> 
								
							<input id="keywords" type="text"
							class="form-control" placeholder="Enter Keywords" /> 
								<button id="search" class="btn btn-primary" onclick="searchAnnouncement()">
							 		<i class="fa fa-gear fa-spin"></i>&nbsp;&nbsp;SEARCH HERE
								</button>
						   </span>
					</div>

					<br />
					<table id="readerApplication2" class="table table-striped">
						<thead>
							<tr>
								<th>Order Number</th>
								<th>Content</th>
								<th>Release Time</th>
								<th colspan="2" align="center" valign="middle">Operation</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
					
				</div>



			</div>
		</div>
	</div>

	<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
	<!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
	<!-- JQUERY SCRIPTS -->
	<script src="../assets/js/jquery-1.10.2.js"></script>
	<!-- BOOTSTRAP SCRIPTS -->
	<script src="../assets/js/bootstrap.js"></script>
	<!-- METISMENU SCRIPTS -->
	<script src="../assets/js/jquery.metisMenu.js"></script>
	<!-- CUSTOM SCRIPTS -->
	<script src="../assets/js/custom.js"></script>
	<script src="../js/jquery-1.8.3.min.js"></script>
	<script src="../js/jquery.select.js"></script>
		<div class="md-overlay"></div><!-- the overlay element -->

		<!-- classie.js by @desandro: https://github.com/desandro/classie -->
		<script src="../js/classie.js"></script>
		<script src="../js/modalEffects.js"></script>

		<!-- for the blur effect -->
		<!-- by @derSchepp https://github.com/Schepp/CSS-Filters-Polyfill -->
		<script>
			// this is important for IEs
			var polyfilter_scriptpath = '/js/';
		</script>
		<script src="../js/cssParser.js"></script>
		<script src="../js/css-filters-polyfill.js"></script>
	<script>

	function getReaderNameById(reader_id){
		var xmlhttp, str;
		if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
			xmlhttp = new XMLHttpRequest();
		} else {// code for IE6, IE5
			xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
		}
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

				str = xmlhttp.responseText;

			}
		}
		xmlhttp.open("POST","http://localhost:8088/NWPU/getReaderNameById", false);
		xmlhttp.setRequestHeader("Content-type",
				"application/x-www-form-urlencoded");
		xmlhttp.send("reader_id="+reader_id);
		if (str != null) {
			
			return str;
		}
	}
	function resetContent(){
		document.getElementById("content").value="";
	}
	function delivertContent(){
		var content = document.getElementById("content").value;
		if(content == "" || content == null){
			alert("the content is null!");
		}else{
		var date  = new Date();
		year = date.getFullYear();
		month  = date.getMonth()+1;
		day = date.getDate();
		var myDate = year+"/"+month+"/"+day;
		var xmlhttp;
		if (window.XMLHttpRequest)
		  {// code for IE7+, Firefox, Chrome, Opera, Safari
		  xmlhttp=new XMLHttpRequest();
		  }
		else
		  {// code for IE6, IE5
		  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		  }
		xmlhttp.onreadystatechange=function()
		  {
		  if (xmlhttp.readyState==4 && xmlhttp.status==200)
		    {
			  if(xmlhttp.responseText == "success"){
				  alert("Successfully delivered"); 
				  document.getElementById("content").value="";
				  queryAnnouncement();
			  }
		
		    }
		  }
		xmlhttp.open("POST","http://localhost:8088/NWPU/addAnnouncementServlet",false);
		xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		//xmlhttp.send("fname=Bill&lname=Gates");
		xmlhttp.send("content="+content+"&time="+myDate);
		}
	}
	function add0(m){return m<10?'0'+m:m }
	function getLocalTime(nS) {     
	    
	       var time = new Date(parseInt(nS) * 1000);
	       var y = time.getFullYear();
	       var m = time.getMonth()+1;
	       var d = time.getDate();
	       var h = time.getHours();
	       var mm = time.getMinutes();
	       var s = time.getSeconds();
	       return y+'-'+add0(m)+'-'+add0(d)+' '+add0(h)+':'+add0(mm)+':'+add0(s);
	    } 
	function queryAnnouncement(){
		
		document.getElementById("addUserDiv").style.display = "none";
		document.getElementById("queryUserDiv").style.display = "block";
		clearTbody("readerApplication2");
		document.getElementById("deliverAnnouncement").style.background = "#ffffff";
		document.getElementById("queryAnnouncement").style.background = "#00CA79";
		var userApplicationServlet = "http://localhost:8088/NWPU/getAnnouncementServlet";
		var usersJson = analyseData(userApplicationServlet);
		if (usersJson.length != -1) {
			for (var i = 0; i < usersJson.length; i++) {
				var z = $("readerApplication2").rows.length;
				var tableRow = $("readerApplication2").insertRow(z);

				var Cell_0 = tableRow.insertCell(0);
				Cell_0.innerHTML = z;

				var Cell_1 = tableRow.insertCell(1);
				Cell_1.innerHTML = usersJson[i].content;

				var Cell_2 = tableRow.insertCell(2);
				Cell_2.innerHTML = getLocalTime(usersJson[i].time);

				var Cell_3 = tableRow.insertCell(3);
				//Cell_3.innerHTML = "<button class='btn btn-primary' type='submit' onclick='moreInfAnnoun()'>More</button>";
				Cell_3.innerHTML = '<button id="more" class="test" data-modal="modal-16" onclick="init2(this.parentNode.parentNode.rowIndex)">More</button>';

				var Cell_4 = tableRow.insertCell(4);
				Cell_4.innerHTML = "<button class='btn btn-danger' type='submit' onclick='deleteAnnouncementItem(this.parentNode.parentNode.rowIndex)'>Delete</button>";
			}
		}
		init();
	}
	function init() {

		var overlay = document.querySelector( '.md-overlay' );
	
		[].slice.call( document.querySelectorAll( '.test' ) ).forEach( function( el, i ) {

			var modal = document.querySelector( '#' + el.getAttribute( 'data-modal' ) ),
				close = modal.querySelector( '.md-close' );

			function removeModal( hasPerspective ) {
				classie.remove( modal, 'md-show' );

				if( hasPerspective ) {
					classie.remove( document.documentElement, 'md-perspective' );
				}
			}

			function removeModalHandler() {
				removeModal( classie.has( el, 'md-setperspective' ) ); 
			}

			el.addEventListener( 'click', function( ev ) {
			
				classie.add( modal, 'md-show' );
				overlay.removeEventListener( 'click', removeModalHandler );
				overlay.addEventListener( 'click', removeModalHandler );

				if( classie.has( el, 'md-setperspective' ) ) {
					setTimeout( function() {
						classie.add( document.documentElement, 'md-perspective' );
					}, 25 );
				}
			});

			close.addEventListener( 'click', function( ev ) {
				ev.stopPropagation();
				removeModalHandler();
			});

		} );

	}
	function init2(rowIndex) {
		setAnnouncementInf(rowIndex);

		var overlay = document.querySelector( '.md-overlay' );
	
		[].slice.call( document.querySelectorAll( '.test' ) ).forEach( function( el, i ) {

			var modal = document.querySelector( '#' + el.getAttribute( 'data-modal' ) ),
				close = modal.querySelector( '.md-close' );

			function removeModal( hasPerspective ) {
				classie.remove( modal, 'md-show' );

				if( hasPerspective ) {
					classie.remove( document.documentElement, 'md-perspective' );
				}
				
			}

			function removeModalHandler() {
				removeModal( classie.has( el, 'md-setperspective' ) ); 
			}

			el.addEventListener( 'click', function( ev ) {
				
				classie.add( modal, 'md-show' );
				overlay.removeEventListener( 'click', removeModalHandler );
				overlay.addEventListener( 'click', removeModalHandler );

				if( classie.has( el, 'md-setperspective' ) ) {
					setTimeout( function() {
						classie.add( document.documentElement, 'md-perspective' );
					}, 25 );
				}
			});

			close.addEventListener( 'click', function( ev ) {
				ev.stopPropagation();
				removeModalHandler();
			});

		} );

	}
	function setAnnouncementInf(rowIndex){
		var userApplicationServlet = "http://localhost:8088/NWPU/getAnnouncementServlet";
		var usersJson = analyseData(userApplicationServlet);
		var announcement;
		if(usersJson.length != -1){
			announcement = usersJson[rowIndex-1];
			document.getElementById("announcementId").innerHTML = announcement.id;
			document.getElementById("announcementTime").innerHTML = announcement.time;
			document.getElementById("announcementContent").innerHTML = announcement.content;
		}

	}
	function deliverAnnouncement(){
		document.getElementById("addUserDiv").style.display = "block";
		document.getElementById("queryUserDiv").style.display = "none";
		//clearTbody("readerApplication2");
		document.getElementById("deliverAnnouncement").style.background = "#00CA79";
		document.getElementById("queryAnnouncement").style.background = "#ffffff";
	}
	//清除cookie    
	function DelCookie(name)
{
var exp = new Date();
exp.setTime (exp.getTime() - 1);
var cval = getCookie(name);
document.cookie = name + "=" + cval + "; expires="+ exp.toGMTString();
}
	    function logout(){
	    	var isLogout = confirm("Are you sure you want to log out?");
			if(isLogout == true){
 				DelCookie("idtest");
	    	window.location.href="http://localhost:8088/NWPU/manager2Pages/login.html";
			}
	    }


	
		function changeType3(){
			queryAnnouncement();
			document.getElementById("type").innerText = "Announcement Content";
			document.getElementById("type").style.background="rgb(0, 202, 121)";
			document.cookie = "AnnouncementType=3";
			document.getElementById("keywords").value ="";
	    }


		function searchAnnouncement(){
			clearTbody("readerApplication2");
			var type = getCookie("AnnouncementType");
			
			var keywords = document.getElementById("keywords").value;
			var userApplicationServlet = "http://localhost:8088/NWPU/getAnnouncementServlet";
			var usersJson = analyseData(userApplicationServlet);
			if (usersJson.length != -1) {
				for (var i = 0; i < usersJson.length; i++) {
					var attr;
					if(type == "1"){
						 attr = usersJson[i].id;
					}else if(type == "2"){
						attr = usersJson[i].time;
					}else if(type == "3"){
						attr = usersJson[i].content;
					}
					if(isContains(attr,keywords)){
						var z = $("readerApplication2").rows.length;
						var tableRow = $("readerApplication2").insertRow(z);

						var Cell_0 = tableRow.insertCell(0);
						Cell_0.innerHTML = z;

						var Cell_1 = tableRow.insertCell(1);
						Cell_1.innerHTML = usersJson[i].content;

						var Cell_2 = tableRow.insertCell(2);
						Cell_2.innerHTML = usersJson[i].time;

//		 				var Cell_3 = tableRow.insertCell(3);
//		 				Cell_3.innerHTML = usersJson[i].email;

						var Cell_4 = tableRow.insertCell(3);
						Cell_4.innerHTML = "<button class='btn btn-danger' type='submit' onclick='deleteAnnouncementItem(this.parentNode.parentNode.rowIndex)'>Delete</button>";
					}
				}
			}
			
			
		}
		function isContains(str, substr) {
		    return str.indexOf(substr) >= 0;
		}


		function deleteAnnouncementItem(rowIndex){
			var determination = confirm("Are you sure you want to delete this Announcement?");
			if (determination == true) {
				var userApplicationServlet = "http://localhost:8088/NWPU/getAnnouncementServlet";
				var usersJson = analyseData(userApplicationServlet);
				var index = rowIndex - 1;
				var user = usersJson[index];
				var xmlhttp, str;
				if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
					xmlhttp = new XMLHttpRequest();
				} else {// code for IE6, IE5
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				}
				xmlhttp.onreadystatechange = function() {
					if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						alert("Successfully deleted");
						queryAnnouncement();
					}
				}
				xmlhttp.open("POST",
						"http://localhost:8088/NWPU/deleteAnnouncementServlet", false);
				xmlhttp.setRequestHeader("Content-type",
						"application/x-www-form-urlencoded");
				xmlhttp.send("id=" + user.id + "&content=" + user.content
						+ "&time=" + user.time);
			}
		}
	
		function deleteUserItem(rowIndex) {
			var determination = confirm("Are you sure you want to delete this user?");
			if (determination == true) {
				var userApplicationServlet = "http://localhost:8088/NWPU/getUserServlet";
				var usersJson = analyseData(userApplicationServlet);
				var index = rowIndex - 1;
				var user = usersJson[index];
				var xmlhttp, str;
				if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
					xmlhttp = new XMLHttpRequest();
				} else {// code for IE6, IE5
					xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
				}
				xmlhttp.onreadystatechange = function() {
					if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
						alert("Successfully deleted");
						deleteUser();
					}
				}
				xmlhttp.open("POST",
						"http://localhost:8088/NWPU/deleteUserServlet", false);
				xmlhttp.setRequestHeader("Content-type",
						"application/x-www-form-urlencoded");
				xmlhttp.send("id=" + user.id + "&password=" + user.password
						+ "&email=" + user.email + "&userName=" + user.userName
						+ "&classNumber=" + user.classNumber);
			}

		}
		function clearTbody(tableName) {

			var table = document.getElementById(tableName);
			var tableLength = table.rows.length;
			if (tableLength >= 1) {
				for (var int = 1; int < tableLength; int++) {
					table.deleteRow(1);

				}
			}

		}
		function $(id) {
			return document.getElementById(id);
		}
		function addHero() {
			//document.getElementById("readerApplication").setAttribute("className","table table-striped");
			document.getElementById("queryAnnouncement").style.background = "#00CA79";
			var userApplicationServlet = "http://localhost:8088/NWPU/getUserApplicationRecord";
			var usersJson = analyseData(userApplicationServlet);
			if (usersJson.length != -1) {
				for (var i = 0; i < usersJson.length; i++) {
					var z = $("readerApplication").rows.length;
					var tableRow = $("readerApplication").insertRow(z);

					var Cell_0 = tableRow.insertCell(0);
					Cell_0.innerHTML = z;

					var Cell_1 = tableRow.insertCell(1);
					Cell_1.innerHTML = usersJson[i].id;

					var Cell_2 = tableRow.insertCell(2);
					Cell_2.innerHTML = usersJson[i].userName;

					var Cell_3 = tableRow.insertCell(3);
					Cell_3.innerHTML = usersJson[i].email;

					var Cell_4 = tableRow.insertCell(4);

					Cell_4.innerHTML = "<button class='btn btn-primary' type='submit' onclick='agree(this.parentNode.parentNode.rowIndex)'>Agree</button>";

					var Cell_5 = tableRow.insertCell(5);

					Cell_5.innerHTML = "<button class='btn btn-danger' type='submit' onclick='deny(this.parentNode.parentNode.rowIndex)'>Deny</button>";
				}
			}

		}



		function analyseData(userApplicationServlet) {

			var xmlhttp, str;
			if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
				xmlhttp = new XMLHttpRequest();
			} else {// code for IE6, IE5
				xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
			}
			xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {

					str = xmlhttp.responseText;

				}
			}
			xmlhttp.open("POST", userApplicationServlet, false);
			xmlhttp.setRequestHeader("Content-type",
					"application/x-www-form-urlencoded");
			xmlhttp.send();
			if (str != null) {
				var usersJson = eval('(' + str + ')');
				return usersJson;
			}
 		}
		   function init5() {
		        var username = getCookie("idtest");
		       if(username!="login"){
		    	   window.location.href="http://localhost:8088/NWPU/manager2Pages/login.html";
		    	  //alert("not log in");
		       }
		    }
		function judgeState() {
			document.getElementById("userName").innerHTML = getReaderNameById(getCookie("loginName"));
			init5();
			queryAnnouncement();
			init();
			document.getElementById("type").innerHTML = "Announcement Content";
	    	document.getElementById("type").style.background="rgb(0, 202, 121)";
	    	document.cookie = "AnnouncementType=3";

		}
		function getCookie(cname) {
			var ss = document.cookie;
			var name = cname + "=";
			var ca = document.cookie.split(';');
			for (var i = 0; i < ca.length; i++) {
				var c = ca[i].trim();
				if (c.indexOf(name) == 0)
					return c.substring(name.length, c.length);
			}
			return "";
		}
	</script>
</body>
</html>
